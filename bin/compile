#!/bin/bash

arrow() {
  echo '----->' "$@"
}

indent() {
  sed -u 's/^/       /'
}

skip_old_node_versions() {
    local node_version="$(node --version)"
    if [ "${node_version:1:1}" -lt "8" ] || [ "${node_version:1:2}" -ne "10" ]; then
        echo    ""
        echo -e "       \e[33mThe Heroku Node.js Metrics Plugin does not support Node ${node_version}\e[39m"
        echo    ""
        echo    "       No Node-specific metrics will be collected for this application until it is upgraded."
        echo    "       Read more: https://devcenter.heroku.com/articles/language-runtime-metrics-nodejs"
        echo    ""
        exit 0
    fi
}

BUILD_DIR=$1
#CACHE_DIR=$2
#ENV_DIR=$3

skip_old_node_versions

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

arrow "Setting up .profile.d to automatically run metrics agent..."
mkdir -p "${BUILD_DIR}/.profile.d"
cp .profile.d/heroku-nodejs-metrics-plugin.sh "${BUILD_DIR}/.profile.d"

if [[ -e "${BUILD_DIR}/package.json" ]]; then
    arrow "Installing Nodejs metrics plugin"
    mkdir -p "${BUILD_DIR}/.heroku/"

    node_plugin_dir="${BUILD_DIR}/.heroku/node-metrics-plugin"
    node_metrics_plugin_dir="${BP_DIR}/node-metrics-plugin"

    cp -r $node_metrics_plugin_dir $node_plugin_dir

    cd $node_plugin_dir
    npm install > /dev/null
    cd $BP_DIR

    indent "Metrics agent installed"
fi