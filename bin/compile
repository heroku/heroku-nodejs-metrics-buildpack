#!/bin/bash

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output

BUILD_DIR=$1

arrow() {
  echo '----->' "$@"
}

skip_old_node_versions() {
    local node_version="$(node --version)"
    # major_string will be ex: "6." "8." "10"
    local major_string=${node_version:1:2}
    # strip any "."s from major_string
    local major=${major_string//.}
    if [ "${major}" -lt "8" ]; then
        echo    ""
        echo -e "       \e[33m\e[1mThe Heroku Node.js Metrics Plugin does not support Node ${node_version}\e[39m"
        echo    ""
        echo    "       No Node-specific metrics will be collected for this application."
        echo    "       Read more: https://devcenter.heroku.com/articles/language-runtime-metrics-nodejs"
        echo    ""
        exit 0
    fi
}

skip_node_10_2() {
    local node_version="$(node --version)"
    local snippet=${node_version:1:4}

    if [ "${snippet}" == "10.2" ]; then
        echo    ""
        echo -e "       \e[33m\e[1mThe Heroku Node.js Metrics Plugin does not yet support Node ${node_version}\e[39m"
        echo    ""
        echo -e "       \e[33m\e[1mWe are working to resolve this issue.\e[39m"
        echo    "       https://github.com/heroku/heroku-nodejs-metrics-buildpack/issues/14"
        echo    ""
        echo    "       No Node-specific metrics will be collected for this application."
        echo    "       Read more: https://devcenter.heroku.com/articles/language-runtime-metrics-nodejs"
        echo    ""
        exit 0
    fi
}

### Handle errors

handle_failure() {
  echo    ""
  echo    ""
  echo -e "\e[1m\e[33mAn unknown error occured. Failed to install Heroku Node Metrics plugin\e[0m"
  echo    ""
  echo -e "\e[1mPlease open a support ticket at https://help.heroku.com/\e[0m"
  echo    ""
  echo    ""
}
trap 'handle_failure' ERR

### Main script

skip_old_node_versions
skip_node_10_2

BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

mkdir -p "${BUILD_DIR}/.profile.d"
cp .profile.d/heroku-nodejs-metrics-plugin.sh "${BUILD_DIR}/.profile.d"

if [[ -e "${BUILD_DIR}/package.json" ]]; then
    arrow "Installing Nodejs metrics plugin"
    mkdir -p "${BUILD_DIR}/.heroku/"

    node_plugin_dir="${BUILD_DIR}/.heroku/node-metrics-plugin"
    node_metrics_plugin_dir="${BP_DIR}/node-metrics-plugin"

    cp -r $node_metrics_plugin_dir $node_plugin_dir

    cd $node_plugin_dir
    npm install > /dev/null
    cd $BUILD_DIR

    arrow "Nodejs metrics plugin installed"
fi